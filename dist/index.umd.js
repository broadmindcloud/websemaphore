(function(b,S){typeof exports=="object"&&typeof module<"u"?S(exports):typeof define=="function"&&define.amd?define(["exports"],S):(b=typeof globalThis<"u"?globalThis:b||self,S(b.websemaphore={}))})(this,function(b){"use strict";var S=(o=>(o.Json="application/json",o.FormData="multipart/form-data",o.UrlEncoded="application/x-www-form-urlencoded",o.Text="text/plain",o))(S||{});class k{constructor(t={}){this.baseUrl="https://api-eu-dev.websemaphore.com/v1",this.securityData=null,this.abortControllers=new Map,this.customFetch=(...e)=>fetch(...e),this.baseApiParams={credentials:"same-origin",headers:{},redirect:"follow",referrerPolicy:"no-referrer"},this.setSecurityData=e=>{this.securityData=e},this.contentFormatters={"application/json":e=>e!==null&&(typeof e=="object"||typeof e=="string")?JSON.stringify(e):e,"text/plain":e=>e!==null&&typeof e!="string"?JSON.stringify(e):e,"multipart/form-data":e=>Object.keys(e||{}).reduce((s,l)=>{const r=e[l];return s.append(l,r instanceof Blob?r:typeof r=="object"&&r!==null?JSON.stringify(r):`${r}`),s},new FormData),"application/x-www-form-urlencoded":e=>this.toQueryString(e)},this.createAbortSignal=e=>{if(this.abortControllers.has(e)){const l=this.abortControllers.get(e);return l?l.signal:void 0}const s=new AbortController;return this.abortControllers.set(e,s),s.signal},this.abortRequest=e=>{const s=this.abortControllers.get(e);s&&(s.abort(),this.abortControllers.delete(e))},this.request=async({body:e,secure:s,path:l,type:r,query:p,format:u,baseUrl:i,cancelToken:a,...h})=>{const c=(typeof s=="boolean"?s:this.baseApiParams.secure)&&this.securityWorker&&await this.securityWorker(this.securityData)||{},y=this.mergeRequestParams(h,c),m=p&&this.toQueryString(p),f=this.contentFormatters[r||"application/json"],v=u||y.format;return console.log("Fetching: ",`${i||this.baseUrl||""}${l}${m?`?${m}`:""}`),console.log("Headers: ",`${JSON.stringify(y.headers)}`),console.log("Body: ",`${JSON.stringify(e)}`),this.customFetch(`${i||this.baseUrl||""}${l}${m?`?${m}`:""}`,{...y,headers:{...y.headers||{},...r&&r!=="multipart/form-data"?{"Content-Type":r}:{}},signal:a?this.createAbortSignal(a):y.signal,body:typeof e>"u"||e===null?null:f(e)}).then(async n=>{const g=n;g.data=null,g.error=null;const w=v?await n[v]().then(d=>(g.ok?g.data=d:g.error=d,g)).catch(d=>(g.error=d,g)):g;if(a&&this.abortControllers.delete(a),!n.ok)throw w;return w})},Object.assign(this,t)}encodeQueryParam(t,e){return`${encodeURIComponent(t)}=${encodeURIComponent(typeof e=="number"?e:`${e}`)}`}addQueryParam(t,e){return this.encodeQueryParam(e,t[e])}addArrayQueryParam(t,e){return t[e].map(l=>this.encodeQueryParam(e,l)).join("&")}toQueryString(t){const e=t||{};return Object.keys(e).filter(l=>typeof e[l]<"u").map(l=>Array.isArray(e[l])?this.addArrayQueryParam(e,l):this.addQueryParam(e,l)).join("&")}addQueryParams(t){const e=this.toQueryString(t);return e?`?${e}`:""}mergeRequestParams(t,e){return{...this.baseApiParams,...t,...e||{},headers:{...this.baseApiParams.headers||{},...t.headers||{},...e&&e.headers||{}}}}}class C extends k{constructor(){super(...arguments),this.advisor={generateMapping:(t,e={})=>this.request({path:"/advisor/generateMapping",method:"POST",body:t,secure:!0,type:"application/json",format:"json",...e}),optionsAdvisor:(t={})=>this.request({path:"/advisor/generateMapping",method:"OPTIONS",type:"application/json",...t})},this.apikey={list:(t,e={})=>this.request({path:"/apikey/readKeys",method:"GET",query:t,secure:!0,type:"application/json",format:"json",...e}),optionsApikey:(t={})=>this.request({path:"/apikey/readKeys",method:"OPTIONS",type:"application/json",...t}),upsert:(t,e={})=>this.request({path:"/apikey/upsertKey",method:"POST",body:t,secure:!0,type:"application/json",format:"json",...e}),optionsApikey2:(t={})=>this.request({path:"/apikey/upsertKey",method:"OPTIONS",type:"application/json",...t})},this.auth={getJwt:(t,e={})=>this.request({path:"/auth/idGetToken",method:"POST",body:t,type:"application/json",format:"json",...e}),optionsAuth:(t={})=>this.request({path:"/auth/idGetToken",method:"OPTIONS",type:"application/json",...t})},this.emails={upsert:(t,e={})=>this.request({path:"/emails/upsertEmail",method:"POST",body:t,type:"application/json",format:"json",...e}),optionsEmails:(t={})=>this.request({path:"/emails/upsertEmail",method:"OPTIONS",type:"application/json",...t})},this.info={infoList:(t={})=>this.request({path:"/info",method:"GET",type:"application/json",...t}),optionsInfo:(t={})=>this.request({path:"/info",method:"OPTIONS",type:"application/json",...t})},this.infoAuth={infoAuthList:(t={})=>this.request({path:"/info-auth",method:"GET",secure:!0,type:"application/json",...t}),optionsInfoAuth:(t={})=>this.request({path:"/info-auth",method:"OPTIONS",type:"application/json",...t})},this.semaphore={read:(t,e={})=>this.request({path:"/semaphore",method:"GET",query:t,secure:!0,type:"application/json",format:"json",...e}),upsert:(t,e={})=>this.request({path:"/semaphore",method:"POST",body:t,secure:!0,type:"application/json",format:"json",...e}),optionsSemaphore:(t={})=>this.request({path:"/semaphore",method:"OPTIONS",type:"application/json",...t}),list:(t,e={})=>this.request({path:"/semaphore/list",method:"GET",query:t,secure:!0,type:"application/json",format:"json",...e}),optionsSemaphore2:(t={})=>this.request({path:"/semaphore/list",method:"OPTIONS",type:"application/json",...t}),acquire:(t,e,s={})=>this.request({path:`/semaphore/${t}/acquire`,method:"POST",body:e,secure:!0,type:"application/json",...s}),acquireSync:(t,e,s={})=>this.request({path:`/semaphore/${t}/acquireSync`,method:"POST",body:e,secure:!0,type:"application/json",format:"json",...s}),optionsSemaphore3:(t,e={})=>this.request({path:`/semaphore/${t}/acquireSync`,method:"OPTIONS",type:"application/json",...e}),activate:(t,e,s={})=>this.request({path:`/semaphore/${t}/activate`,method:"POST",body:e,secure:!0,type:"application/json",format:"json",...s}),optionsSemaphore4:(t,e={})=>this.request({path:`/semaphore/${t}/activate`,method:"OPTIONS",type:"application/json",...e}),purgeQueue:(t,e={})=>this.request({path:`/semaphore/${t}/purge`,method:"DELETE",secure:!0,type:"application/json",format:"json",...e}),optionsSemaphore5:(t,e={})=>this.request({path:`/semaphore/${t}/purge`,method:"OPTIONS",type:"application/json",...e}),readQueue:(t,e,s={})=>this.request({path:`/semaphore/${t}/readQueue`,method:"GET",query:e,secure:!0,type:"application/json",format:"json",...s}),optionsSemaphore6:(t,e={})=>this.request({path:`/semaphore/${t}/readQueue`,method:"OPTIONS",type:"application/json",...e}),release:(t,e,s={})=>this.request({path:`/semaphore/${t}/release`,method:"POST",body:e,secure:!0,type:"application/json",format:"json",...s}),optionsSemaphore7:(t,e={})=>this.request({path:`/semaphore/${t}/release`,method:"OPTIONS",type:"application/json",...e})},this.user={read:(t,e={})=>this.request({path:"/user",method:"GET",query:t,secure:!0,type:"application/json",format:"json",...e}),create:(t,e={})=>this.request({path:"/user",method:"POST",body:t,secure:!0,type:"application/json",format:"json",...e}),update:(t,e={})=>this.request({path:"/user",method:"PUT",body:t,secure:!0,type:"application/json",format:"json",...e}),optionsUser:(t={})=>this.request({path:"/user",method:"OPTIONS",type:"application/json",...t}),activityStream:(t,e={})=>this.request({path:"/user/activityStream",method:"GET",query:t,secure:!0,type:"application/json",format:"json",...e}),optionsUser2:(t={})=>this.request({path:"/user/activityStream",method:"OPTIONS",type:"application/json",...t}),current:(t,e={})=>this.request({path:"/user/current",method:"GET",query:t,secure:!0,type:"application/json",format:"json",...e}),optionsUser3:(t={})=>this.request({path:"/user/current",method:"OPTIONS",type:"application/json",...t}),updatePassword:(t,e={})=>this.request({path:"/user/password",method:"PUT",body:t,secure:!0,type:"application/json",format:"json",...e}),optionsUser4:(t={})=>this.request({path:"/user/password",method:"OPTIONS",type:"application/json",...t})}}}class P extends C{}const q={dev:"https://api-eu-dev.websemaphore.com/v1",prod:"https://api.websemaphore.com/v1"},L=o=>{let t,e=(o==null?void 0:o.token)||"";const s=(...r)=>{o!=null&&o.logLevel&&console.log("WebSemaphoreHttpClientManager",...r)};return{initialize:r=>{let{baseUrl:p,fetch:u}=r||{};return p=p||"prod",q[p]&&(p=q[p]),s(p),t=new P({baseUrl:p,securityWorker:i=>i?{headers:{Authorization:i.token}}:{},customFetch:u||((...i)=>fetch(...i))}),r!=null&&r.token&&t.setSecurityData({token:r.token}),t},getCurrentToken(){return e},updateToken(r){e=r,t.setSecurityData({token:r})},async authorize(){try{const r=await t.user.current();return s(`Logged in with ${r.data.id}`),r.data}catch(r){throw r}}}};function W(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var E={exports:{}};(function(o){var t=Object.prototype.hasOwnProperty,e="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(e=!1));function l(i,a,h){this.fn=i,this.context=a,this.once=h||!1}function r(i,a,h,c,y){if(typeof h!="function")throw new TypeError("The listener must be a function");var m=new l(h,c||i,y),f=e?e+a:a;return i._events[f]?i._events[f].fn?i._events[f]=[i._events[f],m]:i._events[f].push(m):(i._events[f]=m,i._eventsCount++),i}function p(i,a){--i._eventsCount===0?i._events=new s:delete i._events[a]}function u(){this._events=new s,this._eventsCount=0}u.prototype.eventNames=function(){var a=[],h,c;if(this._eventsCount===0)return a;for(c in h=this._events)t.call(h,c)&&a.push(e?c.slice(1):c);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(h)):a},u.prototype.listeners=function(a){var h=e?e+a:a,c=this._events[h];if(!c)return[];if(c.fn)return[c.fn];for(var y=0,m=c.length,f=new Array(m);y<m;y++)f[y]=c[y].fn;return f},u.prototype.listenerCount=function(a){var h=e?e+a:a,c=this._events[h];return c?c.fn?1:c.length:0},u.prototype.emit=function(a,h,c,y,m,f){var v=e?e+a:a;if(!this._events[v])return!1;var n=this._events[v],g=arguments.length,w,d;if(n.fn){switch(n.once&&this.removeListener(a,n.fn,void 0,!0),g){case 1:return n.fn.call(n.context),!0;case 2:return n.fn.call(n.context,h),!0;case 3:return n.fn.call(n.context,h,c),!0;case 4:return n.fn.call(n.context,h,c,y),!0;case 5:return n.fn.call(n.context,h,c,y,m),!0;case 6:return n.fn.call(n.context,h,c,y,m,f),!0}for(d=1,w=new Array(g-1);d<g;d++)w[d-1]=arguments[d];n.fn.apply(n.context,w)}else{var x=n.length,j;for(d=0;d<x;d++)switch(n[d].once&&this.removeListener(a,n[d].fn,void 0,!0),g){case 1:n[d].fn.call(n[d].context);break;case 2:n[d].fn.call(n[d].context,h);break;case 3:n[d].fn.call(n[d].context,h,c);break;case 4:n[d].fn.call(n[d].context,h,c,y);break;default:if(!w)for(j=1,w=new Array(g-1);j<g;j++)w[j-1]=arguments[j];n[d].fn.apply(n[d].context,w)}}return!0},u.prototype.on=function(a,h,c){return r(this,a,h,c,!1)},u.prototype.once=function(a,h,c){return r(this,a,h,c,!0)},u.prototype.removeListener=function(a,h,c,y){var m=e?e+a:a;if(!this._events[m])return this;if(!h)return p(this,m),this;var f=this._events[m];if(f.fn)f.fn===h&&(!y||f.once)&&(!c||f.context===c)&&p(this,m);else{for(var v=0,n=[],g=f.length;v<g;v++)(f[v].fn!==h||y&&!f[v].once||c&&f[v].context!==c)&&n.push(f[v]);n.length?this._events[m]=n.length===1?n[0]:n:p(this,m)}return this},u.prototype.removeAllListeners=function(a){var h;return a?(h=e?e+a:a,this._events[h]&&p(this,h)):(this._events=new s,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=e,u.EventEmitter=u,o.exports=u})(E);var _=E.exports;const I=W(_),O=()=>{const o={};let t=new Promise((e,s)=>{o.resolve=e,o.reject=s});return t.resolve=o.resolve,t.reject=o.reject,t},N={dev:"wss://wsapi-eu-dev.websemaphore.com/v1",prod:"wss://wsapi.websemaphore.com/v1"};class $ extends I{constructor(t,e){super(),this.pingCounter=0,this.outboundQueue=[],this.token="",this.url="",this.noReconnect=!1,this.logLevel="",this.boundListeners=[];const s=e!=null&&e.websockets?e.websockets:globalThis.WebSocket;this.WSImplementation=s;const l=(e==null?void 0:e.env)||"prod";if(this.url=(e==null?void 0:e.url)||N[l],this.socket=null,this.upd=t,this.toggle=this.toggle.bind(this),this.send=this.send.bind(this),!s)throw new Error("No websockets implementation provided or available natively")}log(...t){this.logLevel&&console.log("WebSemaphoreWebsocketsTransportClient",...t)}isConnected(){var t;debugger;return this.log("Ready state: ",(t=this.socket)==null?void 0:t.readyState),this.socket&&this.socket.readyState===this.socket.OPEN}initPing(){this.pingInterval=setInterval(()=>{var t;(t=this.socket)==null||t.send("ping"),this.pingCounter++,this.log("ping, pingCounter == ",this.pingCounter)},1e4)}stopPing(){clearInterval(this.pingInterval)}processPong(t){t.data==="pong"&&(this.pingCounter--,this.log("pong, pingCounter == ",this.pingCounter,new Date().toISOString()))}logError(t){this.log(t)}addEventListeners(){if(!this.socket)throw new Error("Socket is not available");this.boundListeners=[{name:"open",handler:this.initPing},{name:"open",handler:this.flush},{name:"close",handler:this.onClose},{name:"error",handler:this.logError},{name:"message",handler:this.processPong},{name:"message",handler:this.forwardEvents}].map(t=>({name:t.name,handler:t.handler.bind(this)})),this.boundListeners.forEach(t=>{var e;return(e=this.socket)==null?void 0:e.addEventListener(t.name,t.handler)})}removeEventListeners(){if(!this.socket)throw new Error("Socket is not available");this.boundListeners.forEach(t=>{var e;return(e=this.socket)==null?void 0:e.removeEventListener(t.name,t.handler)}),this.noReconnect=!0}forwardEvents(t){t.data!=="pong"&&this.emit("message",t)}onClose(){this.stopPing(),!this.noReconnect&&this.token?this.toggle(this.token):this.removeEventListeners(),this.noReconnect=!1}async toggle(t=""){var l,r;this.token=t;const e=this.upd(this.url,this.token),s=!t;if(this.log("Websemaphore Websockets connection is toggling",s?"off":"on"),!(this.url===e&&t==this.token&&((l=this.socket)==null?void 0:l.readyState)===((r=this.socket)==null?void 0:r.OPEN)))return this.url=e,s&&await this.flush(),this.socket?this.socket.close():(this.socket=new this.WSImplementation(this.url),this.addEventListeners()),Promise.resolve()}send(t){var e;if(this.log("Sending",t),!this.isConnected()){this.outboundQueue.unshift(t);return}typeof t!="string"&&(t=JSON.stringify(t)),(e=this.socket)==null||e.send(t)}async flush(){const t=O(),e=this.socket;let s=0;const l=this.outboundQueue||[];for(this.log("Flushing outbound queue has items:",l.length);l.length;)this.send(l.pop());const r=()=>{if(this.log("Flushing #",s++),!this.isConnected())return t.resolve();(e==null?void 0:e.bufferedAmount)?(this.log("Items in buffer #",s++),setTimeout(()=>{r()},500)):(this.log("ResolveWhenDone Done"),t.resolve())};return r(),t}}class T{constructor(t){if(this.logLevel="",this.wsClient=t.wsClient,!this.wsClient)throw new Error("No websockets implementation available. If using in nodejs try `npm i ws` or equivalent");this.cache={inFlight:{},history:[]},this.wsClient.addListener("message",e=>{this._processIncoming(e.data)})}acquire({semaphoreId:t,channelId:e,sync:s,body:l}){let r=0;const p=Date.now().toString()+"-"+r++;this.wsClient.send({action:s?"lock.acquireSync":"lock.acquire",payload:JSON.stringify({id:p,body:l||"{}"}),semaphoreId:t,channelId:e});const u=O();return this.cache.inFlight[p]={promise:u,status:"waiting",release:()=>{throw new Error("Cannot call release before the lock is acquired or rejected")}},u.then(i=>({status:i.status,payload:i.payload,release:()=>this.release({semaphoreId:t,channelId:e,messageId:p})}))}log(...t){this.logLevel&&console.log("WebSemaphoreWebsocketsClient",...t)}_processIncoming(t){this.log("Got a message from WebSemaphore",t);const e=JSON.parse(t);if(e.type==="lock"){e.event;const s=this.cache.inFlight[e.payload.id];s.promise.resolve({...s,status:e.event,payload:e.payload})}}release({semaphoreId:t,channelId:e,messageId:s}){this.wsClient.send({action:"lock.release",semaphoreId:t,channelId:e}),this.log("Releasing..."),delete this.cache.inFlight[s],this.cache.history.push(s)}client(){return this.wsClient}setClient(t){this.wsClient=t}getCache(){return this.cache}}const A=o=>{const t=o!=null&&o.websockets?o.websockets:globalThis.WebSocket,e=new $((p,u)=>`${p}?token=${encodeURIComponent(u)}`,{websockets:t});let s=new T({wsClient:e,logLevel:o==null?void 0:o.logLevel});return{connect:async p=>{if(!p||!p.replace(/^ApiKey./,""))throw new Error("Couln't connect (did you pass a token?)");const u=O();if(await e.toggle(p),!e.socket)throw new Error("Websocket was not created, the provided implementation might be incompatible.");return e.socket.addEventListener&&e.socket.addEventListener("error",i=>{debugger;o!=null&&o.logLevel&&console.log("Couldn't connect, aborted...",i),u.reject(i)}),e.socket.addEventListener("open",i=>{o!=null&&o.logLevel&&console.log("Connected..."),u.resolve(s)}),u},disconnect:()=>e.toggle(),wsClient:e,client:s}};b.Api=C,b.ContentType=S,b.HttpClient=k,b.WebSemaphoreHttpClientManager=L,b.WebSemaphoreWebsocketsClient=T,b.WebSemaphoreWebsocketsClientManager=A,b.WebsemaphoreHttpClient=P,Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});
